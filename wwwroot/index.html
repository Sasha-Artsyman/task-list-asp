<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Task list</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/site.css" type="text/css">
</head>
<body>
    <div id="header">
        <button id="title" class="bblock"><a href="./index.html"><b>Task list</b></a></button>
        <button id="add" class="bblock"><a href="./task.html">+ Add</a></button>
    </div>
    <form name="taskForm">
        <div id="table"></div>
    </form>

    <script>
        // получить все записи
        async function getTasks() {
            // отправляет запрос и получаем ответ
            const response = await fetch("/api/tasks", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            // если запрос прошел нормально
            if (response.ok === true) {
                // получаем данные
                const tasks = await response.json();
                var rows = document.querySelector("#table");
                // добавляем полученные элементы в таблицу
                rows.innerHTML = "";
                tasks.forEach(task => {
                    rows.appendChild(row(task));
                })
            }
        }

        // удаление записи
        async function deleteTask(id) {
            const response = await fetch("/api/tasks/" + id, {
                method: "DELETE",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const tasks = await response.json();
                var thisTask = document.getElementById(tasks.id);
                thisTask.remove();
            }
            else {
                const error = await response.json();
                console.log(error.message);
            }
        }

        // отметка выполнения
        async function doneTask(id) {
            const response = await fetch("/api/tasks/" + id, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });

            if (response.ok === true) {
                const task = await response.json();
                if (task.done === true)
                    var taskDone0 = false;
                else
                    var taskDone0 = true;
                const response0 = await fetch("api/tasks", {
                    method: "PUT",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: task.id,
                        title: task.title,
                        description: task.description,
                        autor: task.autor,
                        date: task.date,
                        done: taskDone0
                    })
                });
                if (response0.ok === true) {
                    reset();
                }
                else {
                    const error = await response0.json();
                    console.log(error.message);
                }
            }
            else {
                // если произошла ошибка, получаем сообщение об ошибке
                const error = await response.json();
                console.log(error.message); // и выводим его на консоль
            }
        }

        function reset() {
            const form = document.forms["taskForm"];
            form.reset();
        }

        // создание строки для таблицы
        function row(task) {

            var div = document.createElement("div");
            if (task.done == false) {
                div.setAttribute("class", "elementFalse");
            }
            else {
                div.setAttribute("class", "elementTrue");
            }
            div.setAttribute("id", task.id);

            var buttonDelete = document.createElement("button");
            buttonDelete.setAttribute("class", "elementDelete");
            buttonDelete.textContent = "Delete";
            buttonDelete.addEventListener("click", e => {
                e.preventDefault();
                deleteTask(task.id);
            });
            div.appendChild(buttonDelete);

            var divTitle0 = document.createElement("div");
            divTitle0.setAttribute("class", "elementTitle0");
            var buttonDone = document.createElement("button");
            buttonDone.setAttribute("class", "elementButtonDone");
            buttonDone.textContent = "";
            buttonDone.addEventListener("click", e => {
                doneTask(task.id);
            });
            divTitle0.appendChild(buttonDone);
            var divTitle = document.createElement("div");
            divTitle.setAttribute("class", "elementTitle");
            var pTitle = document.createElement("p");
            var aTitle = document.createElement("a");
            aTitle.setAttribute("href", "./task.html?" + task.id);
            aTitle.setAttribute("id", "aTitle");
            aTitle.textContent = task.title;
            pTitle.appendChild(aTitle);
            divTitle.appendChild(pTitle);
            divTitle0.appendChild(pTitle);
            div.appendChild(divTitle0);

            var divDescription = document.createElement("div");
            divDescription.setAttribute("class", "elementDescription");
            divDescription.textContent = task.description;
            div.appendChild(divDescription);

            var divOther = document.createElement("div");
            divOther.setAttribute("class", "elementOther");
            var divDate = document.createElement("div");
            divDate.setAttribute("class", "elementDate");
            divDate.textContent = task.date;
            divOther.appendChild(divDate);
            var divAutor = document.createElement("div");
            divAutor.setAttribute("class", "elementAutor");
            divAutor.textContent = task.autor;
            divOther.appendChild(divAutor);
            div.appendChild(divOther);

            return div;
        }

        // загрузка списка
        getTasks();
    </script>
</body>
</html>
