<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Task list</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/site.css" type="text/css">
</head>
<body>
    <div id="header">
        <button id="title" class="bblock"><a href="./index.html"><b>Task list</b></a></button>
        <button id="add" class="bblock"><a href="./task.html">+ Add</a></button>
    </div>
    <form name="taskForm">
        <div id="table"></div>
    </form>

    <script>
        // получить все записи
        async function getTasks() {
            // отправляет запрос и получаем ответ
            const response = await fetch("/api/tasks", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            // если запрос прошел нормально
            if (response.ok === true) {
                // получаем данные
                const tasks = await response.json();
                var rows = document.querySelector("#table");
                // добавляем полученные элементы в таблицу
                rows.innerHTML = "";
                tasks.forEach(task => {
                    rows.appendChild(row(task));
                })
            }
        }

        // удаление записи
        async function deleteTask(id) {
            const response = await fetch("/api/tasks/" + id, {
                method: "DELETE",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const tasks = await response.json();
                var thisTask = document.getElementById(tasks.id);
                thisTask.remove();
            }
            else {
                const error = await response.json();
                console.log(error.message);
            }
        }

        // создание строки для таблицы
        function row(task) {

            var div = document.createElement("div");
            if (task.done == false) {
                div.setAttribute("class", "elementFalse");
            }
            else {
                div.setAttribute("class", "elementTrue");
            }
            div.setAttribute("id", task.id);

            var divTitle = document.createElement("div");
            divTitle.setAttribute("class", "elementTitle");
            divTitle.textContent = task.title;
            div.appendChild(divTitle);

            var divDescription = document.createElement("div");
            divDescription.setAttribute("class", "elementDescription");
            divDescription.textContent = task.description;
            div.appendChild(divDescription);

            var divDelete = document.createElement("button");
            divDelete.setAttribute("class", "elementdivDelete");
            divDelete.textContent = "Delete";
            divDelete.addEventListener("click", e => {
                e.preventDefault();
                deleteTask(task.id);
            });
            div.appendChild(divDelete);

            return div;
        }

        // загрузка списка
        getTasks();
    </script>
</body>
</html>
